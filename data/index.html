

<style>
* { font-family: sans; }
div, table {  display: table; margin: 10px; padding: 10px; border-radius: 10px; background-color: rgba(0,0,0,0.2); }
table { display: inline-block; vertical-align: top }
input, button {margin: 1px}
h2 input { width: 1em;}
input[type="number"] { width: 5em; text-align: right;}
h2,h3,h4 {margin-top: 5px; margin-bottom: 3px}
</style>

<a href="#0">Channel 0</a> <a href="#1">Channel 1</a> <a href="#2">Channel 2</a> <a href="#3">Channel 3</a><br>
<table class=channel>
  <tr><th colspan=2><h2>Channel <span id=channel></span></h2></th></tr>
  <tr><td>Driver</td><td>
    <select id=driver_id onchange="set(this)">
      <option value=0>Disabled</option>
      <option value=1>Stepper</option>
      <option value=2>RC Servo</option>
      <option value=3>PWM</option>
      <option value=4>CyberGear</option>
    </select> </td></tr>
  <tr><td>on Pin / Address  </td><td> <input id=pin_id onchange="set(this)"></td>
  <tr><td>Actual </td><td> <input id=position disabled> </td></tr>
  <tr><td>Target </td><td> <input id=target onchange="set(this)" disabled> </td></tr>
  <tr><td>Torque </td><td> <input id=torque disabled> </td></tr>
  <tr><td>Temp   </td><td> <input id=temperature disabled> </td></tr>
  <tr><td>Alarm  (reset by disable) </td><td> <input id=alarm disabled></td></tr>
  <tr><td>Enabled </td><td> <input id=enabled onchange="set(this)"> </td></tr>
  <tr><td>Enable on Power On </td><td> <input id=poweron_en onchange="set(this)"> </td></tr>
  <tr><td><h3>Motion sources</h3></td></tr>
  <tr><td>Offset </td><td> <input id=offset  onchange="set(this)"> </td></tr>
  <tr><td><h4>Oscillate</h4></td></tr>
  <tr><td>Frequency </td><td>  <input id=osc_f  onchange="set(this)"> </td></tr>
  <tr><td>Amplitude </td><td>  <input id=osc_a onchange="set(this)"> </td></tr>
  <tr><td>Phase </td><td>      <input id=osc_p onchange="set(this)"> </td></tr>
  <tr><td><h4>Random</h4></td></tr>
  <tr><td>Static delay </td><td>  <input id=random_d  onchange="set(this)"> </td></tr>
  <tr><td>Random delay </td><td>  <input id=random_rd onchange="set(this)"> </td></tr>
  <tr><td>Amplitude </td><td>     <input id=random_a  onchange="set(this)"> </td></tr>
  <tr><td><h4>ArtNet DMX Input</h4></td></tr>
  <tr><td>DMX Channel </td><td> <input id=dmx_channel onchange="set(this)"> </td></tr>
  <tr><td>DMX Scale </td><td>     <input id=scale  onchange="set(this)"> </td></tr>
  <tr><td><h4>Inverse Kinematic Motion</h4></td></tr>
  <tr><td>Scale ( per full turn ) </td><td>  <input id=ik_a onchange="set(this)"> </td></tr>
  <tr><td><h3>Motion Limits</h3></td></tr>
  <tr><td>Speed </td><td>     <input id=speed  onchange="set(this)"> </td></tr>
  <tr><td>Accel / Torque </td><td>     <input id=accel  onchange="set(this)"> </td></tr>
  <tr><td>Pos kp </td><td>     <input id=pos_kp  onchange="set(this)"> </td></tr>
  <tr><td>Pos kd </td><td>     <input id=pos_kd  onchange="set(this)"> </td></tr>
  <tr><td colspan=2><button id="reset_zero" onclick="this.value=1; set(this)">Reset position to zero</button> </td></tr>
  <tr><td>Reset position to </td><td> <input type=number id=set_position onchange="set(this)"> </td></tr>
  <tr><td><h3>Misc</h3></td></tr>
  <tr><td>Write new CAN ID </td><td> <input type=number id=set_can_id onchange="set(this)"> </td></tr>
</table>

<table id=global_config>
  <tr><th colspan=2><h2>Global</h2></th></tr>
  <tr><th colspan=2><h3>Status</h3></th></tr>
  <tr><td>Cycle time (ms) </td><td>   <input id=dt disbled> </td></tr>
  <tr><td>Worst cycle (ms) </td><td>  <input id=dt_max disbled> </td></tr>
  <tr><td>IK Position error </td><td>  <input id=ik_error disbled>  </td></tr>
  <tr><td><h3>Network</h3> </td></tr>
  <tr><td>Name </td><td>  <input id=name onchange="set(this)"> </td></tr>
  <tr><td>WiFi SSID </td><td> <input id=ssid onchange="set(this)"> </td></tr>
  <tr><td>WiFi PSK </td><td>  <input type=password id=psk  onchange="set(this)"> </td></tr>
  <tr><td><button id=reset onclick="set(this)">connect</button> </td></tr>
  <tr><td><h3>Inverse Kinematics</h3> </td></tr>
</table>


<script>
function set(el) {
  let channel_id = document.location.hash.substring(1) || 0;
  let param = el.id;
  let value = el.value;
  fetch(`/set?channel_id=${channel_id}&${param}=${value}`);
  el.blur();
  el.value = '';

  fetch_and_show("/config");
}

function show(id, value) {
  let el = document.getElementById(id);
  if(!el) {
    let container = document.getElementById('global_config');
    if(container.lastChild && container.lastChild.id 
      && container.lastChild.id.slice(-2) != id.slice(-2) 
      && container.lastChild.id.slice(0,4) != id.slice(0,4) 
        )
      container.append(document.createElement("hr"));
    let label = document.createElement('span');
    label.innerText = id;
    container.append(label);
    el = document.createElement('input');
    el.setAttribute('id',id);
    el.setAttribute('onchange','set(this)');
    el.setAttribute('size','6');
    container.append(el);
  }
  if(el && !isNaN(parseInt(value)))
    el.setAttribute('type','number');
  if(el && el != document.activeElement)
    el.value = value;
}

async function fetch_and_show(url) {
  let channel_id = document.location.hash.substring(1) || 0;
  let body = await(fetch(url+`?channel_id=${channel_id}`).then(r => r.text()));
  let lines = body.split('\n');
  for(let line of lines) {
    let parts = line.split(/ (.*)/s); // split on first " " only
    if(parts[0])
      show(parts[0],parts[1]);
  }
}


for(let channel_id=0; channel_id<4; channel_id++) {
  let tpl = document.querySelector('.channel');
  let channel_el = tpl.cloneNode(true);
  channel_el.setAttribute('channel',channel_id);
  tpl.insertAdjacentElement('afterend', channel_el);
  let els = channel_el.querySelectorAll('.channel input:not(#channel_id), .channel select, .channel button');
  for(let el of els)
    el.id = el.id.replace(/_[0-9]+$/, '') + '_'+channel_id;
  channel_el.querySelector('#channel').innerText = ''+channel_id;
}


function update_channel() {
  let channel_id = document.location.hash.substring(1)  || 0;

  let channel_el = document.querySelector(`[channel="${channel_id}"]`);
  for(let el of document.querySelectorAll('.channel'))
    el.style.display='none';
  channel_el.style.display='';

  fetch_and_show("/config");
}
update_channel();
window.onhashchange = update_channel;

document.body.addEventListener('keydown',(e) => {
  if(e.target != document.body) return;
  let channel = e.key.charCodeAt(0) - "a".charCodeAt(0);
  if(channel >= 0 && channel < 4) {
    document.location.hash = '#'+channel;
    update_channel();
  }
});

setInterval(()=>fetch_and_show("/status"),500);


</script>

