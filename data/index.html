

<style>
* { font-family: sans; }
div {  display: table; margin: 10px; padding: 10px; border-radius: 10px; background-color: rgba(0,0,0,0.2); }
input, button {margin: 5px}
</style>

<div>
  <h2>Channel <input id=channel_id value="0" style="font-size:130%; width: 1em;"></h2>
  <div>
    Actual: <input id=position disabled>
    Target: <input id=target onchange="set(this)">
    Torque: <input id=torque disabled>
    Temp:   <input id=temperature disabled>
  </div>
  <div>
    <h3>Enable / Error</h3>
    Alarm: <input id=alarm disabled> (reset by disable / enable)<br/>
    Enabled:  <input id=enable onchange="set(this)"> 
    Enable on Power On: <input id=poweron_en onchange="set(this)">
  </div>
  <div>
  <h3>Homing</h3>
    Home to target: <input id=home onchange="set(this)">
    Reset position to: <input id=set_position onchange="set(this)">
  </div>
</div>

<div>
  <h2>Config</h2>
  <div>
    <h3>Preset Motion</h3>
    <h4>Oscillate</h4> 
    Frequency: <input id=osc_f  onchange="set(this)">
    Amplitude: <input id=osc_a onchange="set(this)">
    <h4>Random</h4>
    Static delay: <input id=random_d  onchange="set(this)">
    Random delay: <input id=random_rd onchange="set(this)">
    Amplitude:    <input id=random_a  onchange="set(this)">
  </div>
  <div>
    <h3>Motion Limits</h3>
    Speed:    <input id=speed  onchange="set(this)">
    Accel:    <input id=accel  onchange="set(this)">
    Pos kp:    <input id=pos_kp  onchange="set(this)">
  </div>
  <div>
    <h3>ArtNet DMX Input</h3>
    DMX Channel:<input id=channel onchange="set(this)">
    DMX Scale:    <input id=scale  onchange="set(this)">
  </div>
  <div>
    Name: <input id=name onchange="set(this)">
    WiFi SSID:<input id=ssid onchange="set(this)">
    WiFi PSK: <input type=password id=psk  onchange="set(this)">
    <button id=reset onclick="set(this)">connect</button>
  </div>
</div>

<script>
function set(el) {
  let channel_id = document.querySelector('#channel_id').value;
  let param = el.id;
  fetch(`/set?channel_id=${channel_id}&${param}=${el.value}`);
  el.blur();
  el.value = '';

  fetch_and_show("/config");
}

function show(id, value) {
  let el = document.getElementById(id);
  if(el && el != document.activeElement)
    el.value = value;
}

async function fetch_and_show(url) {
  let channel_id = document.querySelector('#channel_id').value;
  let body = await(fetch(url+`?channel_id=${channel_id}`).then(r => r.text()));
  let lines = body.split('\n');
  for(let line of lines) {
    let parts = line.split(/ (.*)/s); // split on first " " only
    if(parts[0])
      show(parts[0],parts[1]);
  }
}

setInterval(()=>fetch_and_show("/status"),500);

fetch_and_show("/config");

</script>

