

<style>
* { font-family: sans; }
div {  display: table; margin: 10px; padding: 10px; border-radius: 10px; background-color: rgba(0,0,0,0.2); }
input, button {margin: 5px}
h2 input, h2 select { font-size:120%;}
h2 input { width: 1em;}
</style>

<div>
  <h2>Channel 
    <input id=channel_id onchange="update_channel()" value="0"> : 
    <select id=driver_id onchange="set(this)">
      <option value=0>Disabled</option>
      <option value=1>Stepper</option>
      <option value=2>RC Servo</option>
      <option value=3>PWM</option>
      <option value=4>CyberGear</option>
    </select> on Pin / Address 
    <input id=pin_id onchange="set(this)" style="width: 2em;">
  </h2>
  <div>
    Actual: <input id=position disabled>
    Target: <input id=target onchange="set(this)">
    Torque: <input id=torque disabled>
    Temp:   <input id=temperature disabled>
  </div>
  <div>
    <h3>Enable / Error</h3>
    Alarm: <input id=alarm disabled> (reset by disable / enable)<br/>
    Enabled:  <input id=enable onchange="set(this)"> 
    Enable on Power On: <input id=poweron_en onchange="set(this)">
  </div>
  <div>
    <h3>Motion sources</h3>
    Offset: <input id=offset  onchange="set(this)">
    <h4>Oscillate</h4> 
    Frequency: <input id=osc_f  onchange="set(this)">
    Amplitude: <input id=osc_a onchange="set(this)">
    Phase:     <input id=osc_p onchange="set(this)">
    <h4>Random</h4>
    Static delay: <input id=random_d  onchange="set(this)">
    Random delay: <input id=random_rd onchange="set(this)">
    Amplitude:    <input id=random_a  onchange="set(this)">
    <h4>ArtNet DMX Input</h4>
    DMX Channel:<input id=dmx_channel onchange="set(this)">
    DMX Scale:    <input id=scale  onchange="set(this)">
    <h4>Inverse Kinematic Motion</h4>
    Scale ( units per full turn ): <input id=ik_a onchange="set(this)">
  </div>
  <div>
    <h3>Motion Limits</h3>
    Speed:    <input id=speed  onchange="set(this)">
    Accel / Torque:    <input id=accel  onchange="set(this)">
    Pos kp:    <input id=pos_kp  onchange="set(this)">
    Pos kd:    <input id=pos_kd  onchange="set(this)">
    <button id="set_zero" value="1" onclick="set(this)">Reset position to zero</button>
  </div>
  <div>
  <h3>Misc</h3>
    Home to target: <input id=home onchange="set(this)">
    Reset position to: <input id=set_position onchange="set(this)">
    Write new CAN ID: <input id=set_can_id onchange="set(this)">
  </div>
</div>

<div>
  <h2>Global</h2>
  <div id=global_config>
    <h3>Inverse Kinematics</h3>
  </div>
  <div>
    <h3>Network</h3>
    Name: <input id=name onchange="set(this)">
    WiFi SSID:<input id=ssid onchange="set(this)">
    WiFi PSK: <input type=password id=psk  onchange="set(this)">
    <button id=reset onclick="set(this)">connect</button>
  </div>
</div>

<script>
function set(el) {
  let channel_id = document.querySelector('#channel_id').value;
  let param = el.id;
  fetch(`/set?channel_id=${channel_id}&${param}=${el.value}`);
  el.blur();
  el.value = '';

  fetch_and_show("/config");
}

function show(id, value) {
  let el = document.getElementById(id);
  if(!el) {
    let container = document.getElementById('global_config');
    if(container.lastChild && container.lastChild.id && container.lastChild.id.substr(0,4) != id.substr(0,4) )
      container.append(document.createElement("hr"));
    let label = document.createElement('span');
    label.innerText = id;
    container.append(label);
    el = document.createElement('input');
    el.setAttribute('id',id);
    el.setAttribute('onchange','set(this)');
    el.setAttribute('size','6');
    container.append(el);
  }
  if(el && el != document.activeElement)
    el.value = value;
}

async function fetch_and_show(url) {
  let channel_id = document.querySelector('#channel_id').value;
  let body = await(fetch(url+`?channel_id=${channel_id}`).then(r => r.text()));
  let lines = body.split('\n');
  for(let line of lines) {
    let parts = line.split(/ (.*)/s); // split on first " " only
    if(parts[0])
      show(parts[0],parts[1]);
  }
}

setInterval(()=>fetch_and_show("/status"),500);

function update_channel() {
  fetch_and_show("/config");
}
update_channel();

document.body.addEventListener('keydown',(e) => {
  if(e.target != document.body) return;
  let channel = e.key.charCodeAt(0) - "a".charCodeAt(0);
  if(channel >= 0 && channel < 4) {
    document.querySelector('#channel_id').value = channel;
    update_channel();
  }
});

</script>

